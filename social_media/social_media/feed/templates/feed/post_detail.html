{% extends 'feed/base.html' %}

{% block content %}
<div class="container-fluid pb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Back Button -->
            <div class="mb-3">
                <a href="{% url 'feed:profile' %}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left me-2"></i>Back to Profile
                </a>
            </div>

            <div class="premium-card p-0">
                <div class="row">
                    <!-- Post Image -->
                    <div class="col-md-8 p-0">
                        <img src="{{ post.image.url }}" class="img-fluid w-100" style="max-height: 80vh; object-fit: cover;">
                    </div>
                    
                    <!-- Post Info -->
                    <div class="col-md-4 p-3">
                        <!-- User Header -->
                        <div class="d-flex align-items-center mb-3">
                            {% if post.author.profile.profile_pic %}
                                <img src="{{ post.author.profile.profile_pic.url }}" class="profile-pic-sm me-2">
                            {% else %}
                                <div class="profile-pic-sm me-2 bg-gradient d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user text-white small"></i>
                                </div>
                            {% endif %}
                            <div class="flex-grow-1">
                                <strong>{{ post.author.username }}</strong>
                            </div>
                            <a href="{% url 'feed:share_post' post.id %}" class="btn text-light">
                                <i class="fas fa-share"></i>
                            </a>
                        </div>

                        <!-- Caption -->
                        {% if post.caption %}
                        <div class="mb-3">
                            <p class="mb-1">
                                <strong>{{ post.author.username }}</strong> {{ post.caption }}
                            </p>
                            <small class="text-muted">{{ post.created_at|timesince }} ago</small>
                        </div>
                        {% endif %}

                        <!-- Comments Section -->
                        <div class="comments-section" style="max-height: 300px; overflow-y: auto;">
                            {% for comment in comments %}
                            <div class="comment mb-2">
                                <strong>{{ comment.author.username }}</strong>
                                <span class="ms-1">{{ comment.text }}</span>
                                <br>
                                <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center">No comments yet</p>
                            {% endfor %}
                        </div>

                        <!-- Actions -->
                        <div class="border-top border-secondary pt-3 mt-3">
                            <div class="d-flex justify-content-between mb-3">
                                <button class="btn btn-like {% if request.user in post.likes.all %}liked{% endif %}" 
                                        data-post-id="{{ post.id }}">
                                    <i class="fas fa-heart"></i>
                                    <span class="ms-1">{{ post.total_likes }}</span>
                                </button>
                            </div>

                            <!-- Add Comment -->
                            <form method="POST" class="d-flex">
                                {% csrf_token %}
                                <input type="text" name="comment" class="form-control me-2" placeholder="Add a comment..." required>
                                <button type="submit" class="btn btn-premium">Post</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.profile-pic-sm {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.btn-like.liked {
    color: #ff4757;
}

.comments-section {
    border-bottom: 1px solid #333;
    padding-bottom: 15px;
}

.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
</style>

<script>
// Like functionality
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-like').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            likePost(postId, this);
        });
    });
});

function likePost(postId, button) {
    fetch(`/like-post/${postId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.liked) {
            button.classList.add('liked');
        } else {
            button.classList.remove('liked');
        }
        button.querySelector('span').textContent = data.total_likes;
    });
}

// Auto-scroll comments to bottom
document.addEventListener('DOMContentLoaded', function() {
    const commentsSection = document.querySelector('.comments-section');
    if (commentsSection) {
        commentsSection.scrollTop = commentsSection.scrollHeight;
    }
});
</script>
{% endblock %}